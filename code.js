function getYear(e){return null==e?"":e.substring(0,4)}function restoreMovies(){for(var e=0;e<avoidingMovies.length;e++)restoreMovie(avoidingMovies[e]);updateURL()}function changeCrew(){includeCrew=document.getElementById("crew").checked;var e;if(includeCrew)for(e=0;e<crewEdges.length;e++)-1==avoidingMovies.indexOf(crewEdges[e].split(".")[0])&&addEdge(crewEdges[e].split(".")[0],crewEdges[e].split(".")[1],crewEdges[e].split(".")[2]);else for(e=0;e<crewEdges.length;e++)cy.getElementById(crewEdges[e]).remove()}function redrawGraph(){cy.layout({name:$('input[name="layout"]:checked').val(),animate:!1,padding:10})}function correctRoleDisplay(e){if(includeCrew)return e;if(void 0===nonCrewLookup[e]){for(var o=e.split(" / "),t=[],i=0;i<o.length;i++)"crew: "!==o[i].substring(0,6)&&(t[t.length]=o[i]);nonCrewLookup[e]=t.join(" / ")}return nonCrewLookup[e]}function displayMovie(e,o){void 0===linkLookup[e]&&tmdbObject.getMovieLinks(e),$("#backImage").css("background-image","url('https://image.tmdb.org/t/p/w396/"+posterLookup[e]+"')");var t=movieLookup[e],i=[];o&&(document.getElementById("movieName").innerHTML=t),cy.edges().forEach(function(o){o.id().split(".")[0]==e&&(o.addClass("highlighted"),o.source().style("content",correctRoleDisplay(roleLookup[e][o.source().id()])),o.target().style("content",correctRoleDisplay(roleLookup[e][o.target().id()])),i[i.length]=o.source().id(),i[i.length]=o.target().id())}),cy.nodes().forEach(function(e){-1==i.indexOf(e.id())?(e.style("background-opacity",.3),showingPics&&e.style("background-image-opacity",.3)):e.style("font-style","italic")})}function undisplayMovie(e){document.getElementById("movieName").innerHTML="",$("#backImage").css("background-image",""),cy.edges().removeClass("highlighted"),cy.nodes().style("background-opacity",1),cy.nodes().style("font-style","normal"),showingPics&&cy.nodes().style("background-image-opacity",1),cy.edges().forEach(function(o){o.id().split(".")[0]==e&&(o.source().style("content",actorLookup[o.source().id()]),o.target().style("content",actorLookup[o.target().id()]))})}function changePictures(){document.getElementById("showPics").checked?(cy.nodes().forEach(function(e){e.addClass("picture")}),showingPics=!0):(cy.nodes().forEach(function(e){e.removeClass("picture")}),showingPics=!1)}function removeMovie(e){undisplayMovie(e);var o=[];avoidingMovies[avoidingMovies.length]=e,cy.edges().forEach(function(t){t.id().split(".")[0]==e&&(o[o.length]=t.id())});for(var t=0;t<o.length;t++)cy.getElementById(o[t]).remove();updateURL()}function addEdge(e,o,t){var i=e+"."+Math.min(o,t)+"."+Math.max(o,t);cy.$("#"+i).isEdge()||cy.add({group:"edges",data:{id:i,movie:e,source:Math.min(o,t),target:Math.max(o,t)}})}function restoreMovie(e){for(var o=0;o<Object.keys(roleLookup[e]).length;o++)for(var t=0;t<Object.keys(roleLookup[e]).length;t++)o!=t&&addEdge(e,Object.keys(roleLookup[e])[o],Object.keys(roleLookup[e])[t]);var i=avoidingMovies.indexOf(e);avoidingMovies.splice(i,1),getMovieList()}function centerOfGraph(){if(0===cy.nodes().length)return{x:cy.width()/2,y:cy.height()/2};var e=0,o=0;return cy.nodes().forEach(function(t){e+=t.position("x"),o+=t.position("y")}),e/=cy.nodes().length,o/=cy.nodes().length,{x:e,y:o}}function openLink(e){var o=document.getElementById("link").value,t=linkLookup[e][o];if(""!==t){var i=window.open(linkLookup[e][o],"_blank");i.focus()}}function zoom(e){cy.zoom({level:Number(e),position:centerOfGraph()})}function updateURL(){var e=getCode(),o=window.location.href.split("?")[0]+e;history.pushState("data","",o)}function getCode(){if(0===cy.nodes().length)return"";var e=[""];showingPics?e[0]+="1":e[0]+="0",includeCrew?e[0]+="1":e[0]+="0",e[e.length]=cy.zoom(),e[e.length]=cy.pan("x"),e[e.length]=cy.pan("y"),e[e.length]=cy.nodes().length;for(var o=0;o<cy.nodes().length;o++)e[e.length]=cy.nodes()[o].id(),e[e.length]=cy.nodes()[o].position("x"),e[e.length]=cy.nodes()[o].position("y");for(o=0;o<avoidingMovies.length;o++)e[e.length]=avoidingMovies[o];return"?c="+e.join(";")}function placeCode(e){var o=e.split(";");"1"==o[0][0]?document.getElementById("showPics").checked=!0:document.getElementById("showPics").checked=!1,"1"==o[0][1]?document.getElementById("crew").checked=!0:document.getElementById("crew").checked=!1,cy.zoom(Number(o[1])),cy.pan({x:Number(o[2]),y:Number(o[3])});for(var t=5;t<3*Number(o[4])+5;t+=3)tmdbObject.getName(o[t]);for(t=5;t<3*Number(o[4])+5;t+=3)tmdbObject.addActor(o[t],{x:Number(o[t+1]),y:Number(o[t+2])},!1);for(t=3*Number(o[4])+5;t<o.length;t++)removeMovie(o[t])}var movieCasts={},actorLookup={},movieLookup={},roleLookup={},posterLookup={},picLookup={},crewLookup={},gotRoles={},suggs=[],nonCrewLookup={},avoidingMovies=[],crewEdges=[],includeCrew,showingPics,redraw,cy,linkLookup={},tmdbObject={api_key:"ea410068ee0b9ce6c7cb5f5e0202f423",get_data:function(e,o){var t=new XMLHttpRequest;t.onreadystatechange=function(){4==t.readyState&&200==t.status&&o(t)},t.open("GET",e,!0),t.send()},addName:function(name){this.get_data("http://api.themoviedb.org/3/search/person?query="+name+"&api_key="+this.api_key,function(xmlhttp){eval("var data = "+xmlhttp.responseText+".results[0]"),actorLookup[data.id]=data.name,picLookup[data.id]=data.profile_path,tmdbObject.addActor(data.id,{},redraw)})},getName:function(actID){this.get_data("http://api.themoviedb.org/3/person/"+String(actID)+"?api_key="+this.api_key,function(xmlhttp){eval("var info="+xmlhttp.responseText),actorLookup[actID]=info.name,picLookup[actID]=info.profile_path})},addActor:function(actID,pos,redraw2){void 0===actorLookup[actID]&&this.getName(actID),this.get_data("http://api.themoviedb.org/3/person/"+String(actID)+"/movie_credits?api_key="+this.api_key,function(xmlhttp){pos=={}&&(pos=centerOfGraph()),eval("var actorRoles = "+xmlhttp.responseText+".cast"),eval("var crewRoles = "+xmlhttp.responseText+".crew"),cy.add({group:"nodes",data:{id:actID,name:actorLookup[actID],img:"https://image.tmdb.org/t/p/w396"+picLookup[actID]}}),showingPics&&cy.$("#"+String(actID)).addClass("picture"),redraw2?redrawGraph():cy.$("#"+String(actID)).position(pos);for(var movieID,movieName,j,numLines,i=0;i<actorRoles.length;i++)if(movieID=actorRoles[i].id,void 0===movieCasts[movieID])movieCasts[movieID]=[actID],roleLookup[movieID]={},crewLookup[movieID]={},roleLookup[movieID][actID]=actorRoles[i].character,crewLookup[movieID][actID]=!1;else{for(void 0===roleLookup[movieID][actID]?(roleLookup[movieID][actID]=actorRoles[i].character,crewLookup[movieID][actID]=!1):void 0===gotRoles[actID]&&(roleLookup[movieID][actID]+=" / "+actorRoles[i].character,crewLookup[movieID][actID]=!1),posterLookup[movieID]=actorRoles[i].poster_path,numLines=movieCasts[movieID].length,movieName=actorRoles[i].title+" ("+getYear(actorRoles[i].release_date)+")",j=0;numLines>j;j++)movieLookup[movieID]=movieName,actID!==movieCasts[movieID][j]&&-1==avoidingMovies.indexOf(String(movieID))&&(addEdge(movieID,actID,movieCasts[movieID][j]),(crewLookup[movieID][actID]||crewLookup[movieID][movieCasts[movieID][j]])&&(crewEdges[crewEdges.length]=movieID+"."+Math.min(actID,movieCasts[movieID][j])+"."+Math.max(actID,movieCasts[movieID][j])));movieCasts[movieID][numLines]=actID}for(i=0;i<crewRoles.length;i++)if(movieID=crewRoles[i].id,void 0===movieCasts[movieID])movieCasts[movieID]=[actID],roleLookup[movieID]={},crewLookup[movieID]={},roleLookup[movieID][actID]="crew: "+crewRoles[i].job,crewLookup[movieID][actID]=!0;else{for(void 0===roleLookup[movieID][actID]?(roleLookup[movieID][actID]="crew: "+crewRoles[i].job,crewLookup[movieID][actID]=!0):void 0===gotRoles[actID]&&(roleLookup[movieID][actID]+=" / crew: "+crewRoles[i].job),posterLookup[movieID]=crewRoles[i].poster_path,numLines=movieCasts[movieID].length,movieName=crewRoles[i].title+" ("+getYear(crewRoles[i].release_date)+")",j=0;numLines>j;j++)movieLookup[movieID]=movieName,actID!==movieCasts[movieID][j]&&-1==avoidingMovies.indexOf(String(movieID))&&(addEdge(movieID,actID,movieCasts[movieID][j]),(crewLookup[movieID][actID]||crewLookup[movieID][movieCasts[movieID][j]])&&(crewEdges[crewEdges.length]=movieID+"."+Math.min(actID,movieCasts[movieID][j])+"."+Math.max(actID,movieCasts[movieID][j])));movieCasts[movieID][numLines]=actID}changeCrew(),gotRoles[actID]=!0,$("#addActor").val(""),updateURL()})},getSugg:function(key,query){13==key?(this.addName(query),$("#addActor").autocomplete("close").val("")):""!==query&&this.get_data("http://api.themoviedb.org/3/search/person?query="+query+"&api_key="+this.api_key,function(xmlhttp){suggs=[];var ret;for(eval("ret = "+xmlhttp.responseText+".results"),i=0;i<Math.min(10,ret.length);i++)actorLookup[ret[i].id]=ret[i].name,picLookup[ret[i].id]=ret[i].profile_path,suggs[suggs.length]={label:ret[i].name,data:ret[i].id};$("#addActor").autocomplete({source:function(e,o){o(suggs)},select:function(e,o){tmdbObject.addActor(o.item.data,{},redraw)}}).data("ui-autocomplete")._renderItem=function(e,o){var t;return t=null===picLookup[o.data]?"https://assets.tmdb.org/assets/91c0541cff7ec4947514edd379f0ffd1/images/no-profile-w185.jpg":"https://image.tmdb.org/t/p/w396"+picLookup[o.data],$("<li></li>").data("item.autocomplete",o).append("<img src='"+t+'\'style=\'height:30px\'><a class="float" style="left:45px">'+o.label+"</a>").appendTo(e)}})},getMovieLinks:function(movieID){this.get_data("http://api.themoviedb.org/3/movie/"+movieID+"?api_key="+this.api_key,function(xmlhttp){eval("var data = "+xmlhttp.responseText);var movieName=movieLookup[movieID].replace("&","and");linkLookup[movieID]={},linkLookup[movieID].none="",linkLookup[movieID].website=data.homepage,linkLookup[movieID].wiki="http://www.google.com/search?q=site:en.wikipedia.org+"+movieName.replace(" ","+")+"+film&btnI",linkLookup[movieID].rt="http://www.google.com/search?q=site:rottentomatoes.com+"+movieName.replace(" ","+")+"&btnI",linkLookup[movieID].imdb="http://www.imdb.com/title/"+data.imdb_id,linkLookup[movieID].tmdb="https://www.themoviedb.org/movie/"+movieID})}};$(document).ready(function(){showingPics=document.getElementById("showPics").checked,redraw=document.getElementById("redraw").checked,includeCrew=document.getElementById("crew").checked,cy=cytoscape({container:document.getElementById("cy"),style:cytoscape.stylesheet().selector("node").css({"background-color":"#000","background-fit":"cover",width:"mapData(baz, 0, 10, 10, 40)",height:"mapData(baz, 0, 10, 10, 40)",content:"data(name)"}).selector(".picture").css({width:80,height:80,"background-image":"data(img)"}).selector("edge").css({"line-color":"red",width:2,opacity:.8}).selector(".highlighted").css({"line-color":"black"}),layout:{name:$('input[name="layout"]:checked').val(),padding:10,animate:!1},ready:function(){}}),cy.on("zoom",function(){document.getElementById("zoom").value=cy.zoom(),updateURL()}),cy.on("tapend",function(){updateURL()}),document.oncontextmenu=function(){return!1};var e=$("#movieName");$(document).mousemove(function(o){e.css({top:o.pageY-20,left:o.pageX+20})}),cy.on("cxttap","node",function(e){cy.$("#"+e.cyTarget.id()).remove(),redraw&&redrawGraph()}),cy.on("tapend","node",function(e){updateURL()}),cy.on("cxttap","edge",function(e){removeMovie(e.cyTarget.id().split(".")[0])}),cy.on("tap","edge",function(e){openLink(e.cyTarget.id().split(".")[0])}),cy.on("mouseover","edge",function(e){displayMovie(e.cyTarget.id().split(".")[0],!0)}),cy.on("mouseout","edge",function(e){undisplayMovie(e.cyTarget.id().split(".")[0])});var o=window.location.href,t=o.indexOf("?c=")+3;if(2!==t){var i=o.slice(o.indexOf("?c=")+3,o.length);placeCode(i)}});
